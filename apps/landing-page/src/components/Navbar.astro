---
import { cn } from "@repo/ui/lib/utils";
---

<header
  id="main-navbar"
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 transform translate-y-0"
>
  <div class="absolute inset-0 bg-background/0 backdrop-blur-[0px] transition-all duration-300" id="navbar-bg"></div>
  <div class="absolute inset-x-0 bottom-0 h-px bg-border/0 transition-all duration-300" id="navbar-border"></div>

  <nav class="container mx-auto px-6 h-20 flex items-center justify-between relative z-10">
    <!-- Logo -->
    <a href="#home" class="flex items-center gap-2 group" aria-label="TweetBatch Home">
      <div class="relative w-10 h-10 flex items-center justify-center bg-primary/10 rounded-xl overflow-hidden group-hover:bg-primary/20 transition-colors duration-300">
        <img src="/favicon.svg" alt="TweetBatch" class="w-6 h-6 transition-transform duration-500 group-hover:scale-110 group-hover:rotate-12" />
        <div class="absolute inset-0 bg-gradient-to-tr from-primary/0 via-primary/0 to-primary/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
      </div>
      <span class="font-bold text-xl tracking-tight hidden md:block">TweetBatch</span>
    </a>

    <!-- Desktop Menu -->
    <div class="hidden md:flex items-center gap-1 bg-secondary/50 backdrop-blur-md px-2 py-1.5 rounded-full border border-border/50 shadow-sm">
      {
        [
          { name: "Home", href: "#home" },
          { name: "Features", href: "#features-flow" },
          { name: "Momentum", href: "#momentum-engine" },
          { name: "Kinetic", href: "#kinetic-feed" },
          { name: "Streamline", href: "#streamline-engine" },
        ].map((item) => (
          <a
            href={item.href}
            class="nav-link relative px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground transition-colors rounded-full duration-200"
          >
            <span class="relative z-10">{item.name}</span>
            <div class="absolute inset-0 bg-background rounded-full opacity-0 scale-90 transition-all duration-200 nav-link-bg shadow-sm"></div>
          </a>
        ))
      }
    </div>

    <!-- Right Actions -->
    <div class="flex items-center gap-4">
      <!-- Theme Toggle -->
      <button
        id="theme-toggle"
        class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-secondary/20 hover:bg-secondary/40 text-muted-foreground hover:text-foreground transition-colors border border-transparent hover:border-border"
        aria-label="Toggle theme"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="4"></circle>
          <path d="M12 2v2"></path>
          <path d="M12 20v2"></path>
          <path d="m4.93 4.93 1.41 1.41"></path>
          <path d="m17.66 17.66 1.41 1.41"></path>
          <path d="M2 12h2"></path>
          <path d="M20 12h2"></path>
          <path d="m6.34 17.66-1.41 1.41"></path>
          <path d="m19.07 4.93-1.41 1.41"></path>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 block dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
        </svg>
      </button>

      <!-- Mobile Menu Button -->
      <!-- <button class="md:hidden p-2 text-foreground" id="mobile-menu-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
      </button> -->

      <a
        href="#quantum-cta"
        class="hidden md:inline-flex items-center justify-center h-10 px-6 rounded-full bg-primary text-primary-foreground font-medium text-sm transition-all hover:scale-105 hover:shadow-[0_0_20px_-5px_hsl(var(--primary))]"
      >
        Get Started
      </a>

       <!-- Mobile Menu Toggle -->
       <button id="mobile-menu-toggle" class="md:hidden relative z-50 w-10 h-10 flex flex-col items-center justify-center gap-1.5 group">
          <span class="w-6 h-0.5 bg-foreground transition-all duration-300 origin-center group-[.is-active]:rotate-45 group-[.is-active]:translate-y-2"></span>
          <span class="w-6 h-0.5 bg-foreground transition-all duration-300 group-[.is-active]:opacity-0"></span>
          <span class="w-6 h-0.5 bg-foreground transition-all duration-300 origin-center group-[.is-active]:-rotate-45 group-[.is-active]:-translate-y-2"></span>
       </button>
    </div>
  </nav>

  <!-- Mobile Menu Overlay -->
  <div id="mobile-menu" class="fixed inset-0 z-0 bg-background/95 backdrop-blur-xl flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 md:hidden">
      <div class="flex flex-col items-center gap-8 text-2xl font-bold">
        <a href="#home" class="mobile-link">Home</a>
        <a href="#features-flow" class="mobile-link">Features</a>
        <a href="#momentum-engine" class="mobile-link">Momentum</a>
        <a href="#kinetic-feed" class="mobile-link">Kinetic Feed</a>
        <a href="#streamline-engine" class="mobile-link">Streamline</a>
        <a href="#quantum-cta" class="px-8 py-3 bg-primary text-primary-foreground rounded-full mt-4">Get Started</a>
      </div>
  </div>
</header>

<style>
  /* Active Link Styles */
  .nav-link.active span {
    color: hsl(var(--foreground));
  }
  .nav-link.active .nav-link-bg {
    opacity: 1;
    scale: 1;
  }
</style>

<script>
  import gsap from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  // --- Scroll Effect for Navbar Background ---
  const navbar = document.getElementById("main-navbar");
  const bg = document.getElementById("navbar-bg");
  const border = document.getElementById("navbar-border");

  window.addEventListener("scroll", () => {
    if (window.scrollY > 20) {
      bg?.classList.remove("bg-background/0", "backdrop-blur-[0px]");
      bg?.classList.add("bg-background/80", "backdrop-blur-md");
      border?.classList.remove("bg-border/0");
      border?.classList.add("bg-border/50");
    } else {
      bg?.classList.add("bg-background/0", "backdrop-blur-[0px]");
      bg?.classList.remove("bg-background/80", "backdrop-blur-md");
      border?.classList.add("bg-border/0");
      border?.classList.remove("bg-border/50");
    }
  });

  // --- Active Link Highlighting with IntersectionObserver ---
  const sections = document.querySelectorAll("section");
  const navLinks = document.querySelectorAll(".nav-link");

  const observerOptions = {
    root: null,
    rootMargin: "-20% 0px -20% 0px", // Highlight when section is in middle-ish of viewport
    threshold: 0.1,
  };

  const observerCallback = (entries: IntersectionObserverEntry[]) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        // Remove active class from all
        navLinks.forEach((link) => {
            link.classList.remove("active");
            // Also reset internal state if we did something manual? No, class is enough
        });
        
        // Add active class to corresponding link
        const id = entry.target.getAttribute("id");
        if (id) {
            const activeLink = document.querySelector(`.nav-link[href="#${id}"]`);
            activeLink?.classList.add("active");
        }
      }
    });
  };

  const observer = new IntersectionObserver(observerCallback, observerOptions);
  sections.forEach((section) => observer.observe(section));


  // --- Theme Toggle Logic ---
  const themeToggleBtn = document.getElementById('theme-toggle');
  
  const handleThemeToggle = () => {
    const element = document.documentElement;
    element.classList.toggle("dark");

    const isDark = element.classList.contains("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  };

  themeToggleBtn?.addEventListener("click", handleThemeToggle);


  // --- Mobile Menu Logic ---
  const mobileToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileLinks = document.querySelectorAll('.mobile-link');
  let isMenuOpen = false;

  const toggleMenu = () => {
      isMenuOpen = !isMenuOpen;
      
      if (isMenuOpen) {
          mobileToggle?.classList.add('is-active');
          mobileMenu?.classList.remove('opacity-0', 'pointer-events-none');
          document.body.style.overflow = 'hidden'; // Lock scroll
          
          gsap.fromTo('.mobile-link', 
              { y: 20, opacity: 0 },
              { y: 0, opacity: 1, stagger: 0.1, duration: 0.4, delay: 0.1 }
          );
      } else {
          mobileToggle?.classList.remove('is-active');
          mobileMenu?.classList.add('opacity-0', 'pointer-events-none');
          document.body.style.overflow = '';
      }
  };

  mobileToggle?.addEventListener('click', toggleMenu);

  mobileLinks.forEach(link => {
      link.addEventListener('click', () => {
          if(isMenuOpen) toggleMenu();
      });
  });

  // --- Smooth Scroll for Anchors ---
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const href = this.getAttribute('href');
          if(!href) return;
          
          const target = document.querySelector(href);
          if (target) {
              // Offset for fixed header
              const headerOffset = 80;
              const elementPosition = target.getBoundingClientRect().top;
              const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
  
              window.scrollTo({
                  top: offsetPosition,
                  behavior: "smooth"
              });
          }
      });
  });

</script>
