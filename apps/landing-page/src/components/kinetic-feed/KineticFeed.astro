---
import { cn } from "@repo/ui/lib/utils";
import FluidMesh from "../backgrounds/FluidMesh.astro";

const tweets = [
  { 
    id: 1, 
    user: "@alex_creatives", 
    avatar: "A",
    time: "09:00 AM",
    text: "Consistency isn't rocket science. It's just doing the boring work when you don't feel like it. #BuildInPublic", 
    stats: { likes: 124, retweets: 18 }
  },
  { 
    id: 2, 
    user: "@marketing_guru", 
    avatar: "M",
    time: "11:30 AM",
    text: "If you aren't scheduling your content, you are letting the algorithm dictate your life. Take back control.", 
    stats: { likes: 892, retweets: 145 }
  },
  { 
    id: 3, 
    user: "@indie_dev", 
    avatar: "I",
    time: "02:15 PM",
    text: "Just shipped v2.0! üöÄ The feeling of seeing your users happy is unmatched. #SaaS #IndieHacker", 
    stats: { likes: 56, retweets: 12 }
  },
  { 
    id: 4, 
    user: "@design_thinking", 
    avatar: "D",
    time: "04:45 PM",
    text: "White space is not empty space. It's an active design element. Use it wisely.", 
    stats: { likes: 340, retweets: 89 }
  },
  { 
    id: 5, 
    user: "@growth_hacker", 
    avatar: "G",
    time: "08:00 PM",
    text: "The best growth hack? Building a product people actually want to talk about. Everything else is noise.", 
    stats: { likes: 1205, retweets: 310 }
  }
];
---

<section id="kinetic-feed" class="relative z-20 w-full h-screen bg-background py-10">
  <!-- Dynamic Background Glow -->
    <div class="absolute inset-0 -z-10 bg-background pointer-events-none">
     <canvas id="features-magnetic-grid" class="absolute inset-0 h-full w-full opacity-20 dark:opacity-20 opacity-40"></canvas>
     <div class="absolute top-[20%] right-[10%] w-96 h-96 bg-primary/10 rounded-full blur-[100px] animate-pulse"></div>
     <div class="absolute bottom-[20%] left-[10%] w-64 h-64 bg-purple-500/10 rounded-full blur-[80px] animate-pulse delay-1000"></div>
  </div>

  <div class="h-full w-full flex flex-col items-center justify-center overflow-hidden pt-20">
    
    <!-- Title Section -->
    <div class="absolute top-10 md:top-20 text-center z-10 px-4 w-full">
      <h2 class="text-3xl md:text-5xl font-black tracking-tighter mb-2">
        YOUR <span class="text-primary">SCHEDULE</span>
      </h2>
      <p class="text-muted-foreground text-sm md:text-base">
        A timeline of impact, automated for you.
      </p>
    </div>

    <!-- Feed Container -->
    <div class="relative w-full max-w-4xl px-4 md:px-6 h-[60vh] md:h-[70vh] flex flex-col items-center justify-center">
      
      <!-- Central Line (Draws on scroll) -->
      <div class="absolute left-6 md:left-1/2 top-0 bottom-0 w-[2px] bg-border md:-translate-x-1/2 h-full overflow-hidden">
        <div id="timeline-progress" class="w-full h-full bg-primary origin-top scale-y-0"></div>
      </div>

      <!-- Feed Cards Wrapper -->
      <div id="feed-cards" class="relative w-full h-full">
        {tweets.map((tweet, i) => (
          <div 
            class={cn(
              "feed-card absolute w-[calc(100%-3rem)] md:w-[28rem] p-6 rounded-2xl border border-border bg-card/60 backdrop-blur-md shadow-lg opacity-0 translate-y-20 origin-center will-change-transform will-change-opacity",
              /* Mobile: Always offset from left line */
              "left-12 top-1/2 -translate-y-1/2",
              /* Desktop: Alternate sides */
              "md:top-1/2 md:-translate-y-1/2 md:left-auto md:right-auto",
              i % 2 === 0 ? "md:right-[calc(50%+3rem)]" : "md:left-[calc(50%+3rem)]"
            )}
            data-index={i}
          >
            <!-- Card Connector Dot -->
            <div class={cn(
              "absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full border-2 border-primary bg-background shadow-[0_0_10px_hsl(var(--primary))] z-10 hidden md:block",
              i % 2 === 0 ? "-right-[3.5rem]" : "-left-[3.5rem]" 
            )}></div>

            <!-- Mobile Connector Dot (Always on left) -->
            <div class="md:hidden absolute top-1/2 -translate-y-1/2 -left-[1.6rem] w-3 h-3 rounded-full border-2 border-primary bg-background shadow-[0_0_10px_hsl(var(--primary))] z-10"></div>

            <!-- Content -->
            <div class="flex flex-col gap-3">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div class="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold text-xs">
                    {tweet.avatar}
                  </div>
                  <div class="flex flex-col">
                    <span class="text-xs font-bold leading-none">{tweet.user}</span>
                    <span class="text-[10px] text-muted-foreground">{tweet.time}</span>
                  </div>
                </div>
                <div class="h-6 w-6 rounded-full bg-green-500/10 flex items-center justify-center">
                   <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
              </div>
              
              <p class="text-sm font-medium leading-relaxed">
                {tweet.text}
              </p>

              <div class="flex items-center gap-4 text-xs text-muted-foreground pt-2 border-t border-border/50">
                <span class="flex items-center gap-1">‚ù§Ô∏è {tweet.stats.likes}</span>
                <span class="flex items-center gap-1">üîÅ {tweet.stats.retweets}</span>
              </div>
            </div>
          </div>
        ))}
      </div>

    </div>
  </div>
</section>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  const initKineticFeed = () => {
    const section = document.getElementById('kinetic-feed');
    const progressLine = document.getElementById('timeline-progress');
    const cards = gsap.utils.toArray('.feed-card');
    const bg = document.getElementById('feed-background');

    if (!section) return;

    // Master Timeline
    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: section,
        start: "top top",
        end: "+=2500", // Virtual height
        scrub: 1, // Smooth interaction
        pin: true, // Auto-pinning
      }
    });

    // 1. Line Progress - draws continuously
    tl.to(progressLine, { scaleY: 1, ease: "none", duration: 10 }, 0);

    // 2. Card Animation Stagger
    // We want each card to enter, stay for a bit, then exit.
    // Total duration for cards track needs to match roughly the line drawing.
    
    cards.forEach((card, i) => {
      const element = card as HTMLElement;
      
      // Adjusted Timing for cleaner overlap
      // Increased step slightly to separate dots during transition
      const step = 2.5; 
      const startTime = i * step; 
      
      const entryDuration = 1.5;
      const stayDuration = 1.5;
      const exitDuration = 1.5;
      
      // Entry
      tl.fromTo(element, 
        { 
          yPercent: 120, // Start lower down (relative to card height)
          opacity: 0, 
          scale: 0.8,
          filter: "blur(10px)",
          display: 'block',
          force3D: true // Hardware acceleration hint
        },
        { 
          yPercent: -10, // Slight upward move to center
          opacity: 1, 
          scale: 1,
          filter: "blur(0px)",
          duration: entryDuration,
          ease: "power2.out"
        },
        startTime
      );

      // Exit (Fly up and fade out)
      tl.to(element, 
        {
          yPercent: -120, // Exit upwards
          opacity: 0,
          scale: 0.8,
          filter: "blur(10px)",
          duration: exitDuration,
          ease: "power2.in"
        },
        startTime + entryDuration + stayDuration
      );
    });

    // 3. Ambient Background Fade In
    // We just want it to be visible when we are in the section.
    // The CSS transition handles the smoothness, we just toggle opacity via class or inline style


    ScrollTrigger.create({
        trigger: section,
        start: "top center",
        end: "bottom center",
        onToggle: self => {
            if (bg) bg.style.opacity = self.isActive ? "1" : "0";
        }
    });
  };

  document.addEventListener('astro:page-load', initKineticFeed);
  // Also run on initial load if view transitions aren't fully intercepting yet or for dev HMR
  initKineticFeed();
</script>
