---
/**
 * FlightLoader.astro
 *
 * A state-of-the-art preloader component featuring a "Firebird" animation.
 * The bird flies from bottom-left to center, hovers/flaps wings, then flies off to top-right.
 *
 * Usage: Import and place in your main Layout or index page.
 */
---

<div
    id="flight-loader"
    class="fixed inset-0 z-[99999] flex items-center justify-center bg-background overflow-hidden pointer-events-none"
>
    <!-- Background Gradient / Glow -->
    <div
        class="absolute inset-0 bg-gradient-to-tr from-background via-primary/5 to-background opacity-50"
    >
    </div>

    <!-- Animation Container -->
    <div class="relative w-full h-full max-w-[1920px] max-h-[1080px] mx-auto">
        <!-- The Firebird SVG -->
        <!-- 
             NOTE: This SVG is a placeholder structure. 
             Replace the paths inside #firebird-body, #wing-left, #wing-right with your actual logo paths.
             Ensure the viewBox aligns with your vector graphics.
        -->
        <svg
            id="firebird-svg"
            class="absolute top-1/2 left-1/2 w-[120px] h-[120px] text-primary drop-shadow-[0_0_15px_rgba(255,100,0,0.5)] opacity-0"
            viewBox="0 0 100 100"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
        >
            <g id="firebird-group">
                <!-- Left Wing -->
                <path
                    id="wing-left"
                    d="M30 50 C 20 40, 10 30, 5 45 C 15 55, 30 60, 45 55 Z"
                    fill="currentColor"
                    style="transform-origin: 45px 55px;"></path>

                <!-- Right Wing -->
                <path
                    id="wing-right"
                    d="M70 50 C 80 40, 90 30, 95 45 C 85 55, 70 60, 55 55 Z"
                    fill="currentColor"
                    style="transform-origin: 55px 55px;"></path>

                <!-- Body/Head -->
                <path
                    id="firebird-body"
                    d="M45 55 Q 50 80, 55 55 Q 60 30, 50 15 Q 40 30, 45 55 Z"
                    fill="currentColor"></path>

                <!-- Tail Particles (Simulated) -->
                <circle
                    cx="50"
                    cy="80"
                    r="2"
                    class="animate-pulse opacity-50"
                    fill="currentColor"></circle>
            </g>
        </svg>

        <!-- Motion Path Visualizer (Optional: Hidden by default, useful for debugging) -->
        <svg
            class="absolute inset-0 w-full h-full pointer-events-none opacity-0"
            preserveAspectRatio="none"
        >
            <path
                id="flight-path"
                d=""
                fill="none"
                stroke="red"
                stroke-width="2"></path>
        </svg>
    </div>

    <!-- Optional Loading Text -->
    <div
        class="absolute bottom-10 left-1/2 -translate-x-1/2 text-muted-foreground text-sm tracking-widest uppercase animate-pulse"
    >
        Initializing System...
    </div>
</div>

<script>
    import gsap from "gsap";
    import { MotionPathPlugin } from "gsap/MotionPathPlugin";

    gsap.registerPlugin(MotionPathPlugin);

    // Main Animation Logic
    const initLoader = () => {
        const loader = document.getElementById("flight-loader");
        const bird = document.getElementById("firebird-svg");
        const wingLeft = document.getElementById("wing-left");
        const wingRight = document.getElementById("wing-right");

        if (!loader || !bird) return;

        // 1. Initial State (Start at Bottom-Left relative to center)
        const startX = -window.innerWidth * 0.45;
        const startY = window.innerHeight * 0.45;

        gsap.set(bird, {
            opacity: 0,
            scale: 0.5,
            xPercent: -50,
            yPercent: -50,
            x: startX,
            y: startY,
        });

        // 2. Define the Flight Path
        const masterTl = gsap.timeline({
            onComplete: () => {
                // Remove loader from DOM or hide it
                gsap.to(loader, {
                    opacity: 0,
                    duration: 0.8,
                    onComplete: () => {
                        loader.style.display = "none";
                        // Dispatch event that loading is done
                        window.dispatchEvent(
                            new CustomEvent("loader-complete"),
                        );
                    },
                });
            },
        });

        // === PHASE 1: ENTER & FLY TO CENTER ===
        // Fly from current position (bottom-left) to (0,0) (center)
        masterTl.to(bird, {
            motionPath: {
                path: [
                    { x: startX * 0.5, y: startY * 0.5 }, // Control point for curve
                    { x: 0, y: 0 }, // Center
                ],
                curviness: 1.5,
                autoRotate: true,
                alignOrigin: [0.5, 0.5],
            },
            opacity: 1,
            duration: 2,
            ease: "power2.out",
            scale: 1.5, // Grow as it approaches
        });

        // === PHASE 2: HOVER & FLAP ===
        // We want the bird to stay in center and flap wings.
        // The wing flapping is a separate loop running concurrently or triggered here.

        // Flapping Animation (Loop)
        const flapTl = gsap.timeline({ repeat: -1, yoyo: true });
        flapTl.to([wingLeft, wingRight], {
            rotation: (i) => (i === 0 ? -30 : 30), // Left wing rotates neg, Right wing pos
            scaleY: 0.8,
            duration: 0.15,
            ease: "sine.inOut",
        });

        // Add a "Hover" moment in the master timeline
        // We do this by adding a dummy tween or just a delay
        masterTl.to(bird, {
            y: "+=20", // Slight hover up/down
            yoyo: true,
            repeat: 3,
            duration: 0.5,
            ease: "sine.inOut",
        });

        // === PHASE 3: FLY AWAY ===
        masterTl.to(bird, {
            motionPath: {
                path: [
                    {
                        x: window.innerWidth * 0.5,
                        y: -window.innerHeight * 0.5,
                    }, // Top Right
                ],
                curviness: 1,
                autoRotate: true,
            },
            duration: 1.5,
            scale: 0.5, // Shrink away
            ease: "power2.in",
        });

        // Fade trail
        masterTl.to(bird, { opacity: 0, duration: 0.5 }, "-=0.5");
    };

    // Run on load
    window.addEventListener("load", () => {
        // Small delay to ensure everything is ready
        setTimeout(initLoader, 100);
    });

    // Fallback if load already fired
    if (document.readyState === "complete") {
        initLoader();
    }
</script>
